<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plano y sucesión N-iT</title>
  <link rel="stylesheet" href="../../libs/shared-ui/index.css" />
  <link rel="stylesheet" href="../../libs/app-common/styles.css" />
  <link rel="stylesheet" href="../../libs/musical-grid/musical-grid.css" />
  <!-- Estilos del módulo plano-modular -->
  <link rel="stylesheet" href="../../libs/plano-modular/plano-modular.css" />
  <!-- Estilos del grid-editor -->
  <link rel="stylesheet" href="../../libs/matrix-seq/grid-editor.css" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="../../favicon.ico" />
  <style>
    /* Ajuste para integrar plano-modular con el layout de App19 */
    .plano-container {
      grid-column: 1 / -1;
      grid-row: 1 / -1;
    }

    /* Ocultar contenedores originales si existen */
    #soundlineContainer, #gridArea, #matrixContainer, #timelineContainer {
      display: none !important;
    }

  </style>
</head>
<body data-theme="system">
  <div id="app-root"></div>

  <script type="module">
    import { initHeader } from '../../libs/shared-ui/header.js';
    import { renderApp } from '../../libs/app-common/template.js';

    // Set defaults in localStorage BEFORE header initializes
    const app20Prefs = localStorage.getItem('app20-preferences');
    if (!app20Prefs) {
      localStorage.setItem('app20-preferences', JSON.stringify({
        selectedInstrument: 'piano',
        selectColor: '#FFBB33',
        registry: 4,
        bpm: 100
      }));
    } else {
      // Migrate old orange color to new yellow
      const prefs = JSON.parse(app20Prefs);
      if (prefs.selectColor === '#E4570C') {
        prefs.selectColor = '#FFBB33';
        localStorage.setItem('app20-preferences', JSON.stringify(prefs));
      }
    }

    renderApp({
      root: document.getElementById('app-root'),
      title: 'Plano y sucesión N-iT',
      showSelectColor: false,
      showAccent: false,
      showComplexFractions: false,
      hideT: true,
      hideLeds: true,
      showCircularTimelineToggle: false,
      showHoverToggle: false,
      showIntervalLinesToggle: false,
      showStartSoundDropdown: true,
      showInstrumentDropdown: true,
      showP1Toggle: true,
      showPulseToggle: true,
      showPolyphonyToggle: false,
      controlsLayout: {
        mode: 'vertical'
      },
      randomMenuContent: `
        <label>
          <span>Compás máximo</span>
          <input type="number" id="randCompasMax" value="7" min="1" max="7">
        </label>
        <label>
          <span>Nº Compases máximo</span>
          <input type="number" id="randCyclesMax" value="4" min="1" max="4">
        </label>
        <label>
          <span>BPM mínimo</span>
          <input type="number" id="randBpmMin" value="60" min="30" max="300">
        </label>
        <label>
          <span>BPM máximo</span>
          <input type="number" id="randBpmMax" value="180" min="30" max="300">
        </label>
      `
    });

    // Load selection color BEFORE header initializes
    const app20PrefsJson = localStorage.getItem('app20-preferences');
    const app20PrefsObj = app20PrefsJson ? JSON.parse(app20PrefsJson) : {};
    const storedColor = app20PrefsObj.selectColor || '#FFBB33';
    document.documentElement.style.setProperty('--select-color', storedColor);

    initHeader();

    // After header is initialized, sync color picker value
    const selectColor = document.getElementById('selectColor');
    if (selectColor) {
      selectColor.value = storedColor;
    }

    // Remove template-generated elements we don't need
    document.querySelector('.middle')?.remove();

    // Replace .inputs section with new layout: Compás/Cycles stacked + separator + grid-editor
    const inputsSection = document.querySelector('.inputs');
    if (inputsSection) {
      inputsSection.innerHTML = `
        <!-- Left: Compás + Cycles stacked -->
        <div class="inputs-left-stack">
          <div class="param compas">
            <span class="abbr">Compás</span>
            <div class="circle">
              <input id="inputCompas" type="number" min="1" max="7" value="" />
              <div class="spinner">
                <button id="compasUp" class="spin up" type="button" aria-label="Incrementar Compás"></button>
                <button id="compasDown" class="spin down" type="button" aria-label="Decrementar Compás"></button>
              </div>
            </div>
          </div>
          <div class="param cycle-display">
            <span class="abbr">Nº Compases</span>
            <div class="circle cycle-circle">
              <input id="inputCycle" type="number" min="1" max="4" value="" />
              <div class="cycle-counter__digit" id="cycleDigit"></div>
              <div class="spinner">
                <button id="cycleUp" class="spin up" type="button" aria-label="Incrementar Nº Compases"></button>
                <button id="cycleDown" class="spin down" type="button" aria-label="Decrementar Nº Compases"></button>
              </div>
            </div>
          </div>
        </div>

        <!-- Vertical separator -->
        <div class="inputs-separator"></div>

        <!-- Right: Grid-editor for NrX-iT -->
        <div class="inputs-grid-editor" id="gridEditorContainer">
          <!-- Grid editor will be initialized by main.js -->
        </div>

        <!-- Longitud display (moved to right edge) -->
        <div class="total-length-inline" id="totalLengthParam">
          <div class="circle">
            <span class="total-length__digit" id="totalLengthDigit">--</span>
          </div>
          <span class="abbr">Longitud</span>
        </div>
      `;
    }

    // Extract .controls from timeline-wrapper and restructure for 2-column layout
    const timelineWrapper = document.querySelector('.timeline-wrapper');
    const controls = timelineWrapper?.querySelector('.controls');

    console.log('Template restructure:', {
      timelineWrapper: !!timelineWrapper,
      controls: !!controls
    });

    if (controls && timelineWrapper) {
      // Move controls out of wrapper temporarily
      timelineWrapper.before(controls);

      // Clear timeline-wrapper and rebuild with 2-column structure
      timelineWrapper.innerHTML = `
        <!-- Left Column: Registry + Controls + BPM -->
        <div class="left-column" id="leftColumn">
          <!-- Registry display (read-only, updated by grid scroll) -->
          <div class="param registro" id="registroParam">
            <span class="abbr">Registro</span>
            <div class="circle">
              <input id="inputRegistro" type="number" min="3" max="5" value="4" readonly />
            </div>
          </div>

          <!-- Controls will be inserted here -->
          <div class="controls-container" id="controlsContainer"></div>

          <!-- BPM inline at bottom -->
          <div class="bpm-inline" id="bpmParam">
            <span class="abbr">BPM</span>
            <div class="circle">
              <input id="inputBpm" type="number" min="30" max="300" value="100" />
              <div class="spinner">
                <button id="bpmUp" class="spin up" type="button" aria-label="Incrementar BPM"></button>
                <button id="bpmDown" class="spin down" type="button" aria-label="Decrementar BPM"></button>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Grid 2D (plano-modular renders here) -->
        <div class="right-column" id="rightColumn">
          <!-- plano-modular will render its grid here -->
        </div>
      `;

      // Move controls into the left column
      const controlsContainer = document.getElementById('controlsContainer');
      if (controlsContainer && controls) {
        controlsContainer.appendChild(controls);
      }
    } else {
      console.error('Failed to restructure template - timelineWrapper or controls not found');
    }

    // Add tap tempo button if not present (hidden by default, shown when BPM visible)
    const controlGroup = document.querySelector('.controls');
    if (controlGroup) {
      // Check if tap button exists
      let tapBtn = controlGroup.querySelector('#tapTempoBtn');
      if (tapBtn) {
        tapBtn.style.display = 'none'; // Hidden by default
      }

      // Add tap help span if not present
      if (!controlGroup.querySelector('#tapHelp')) {
        const tapHelp = document.createElement('span');
        tapHelp.id = 'tapHelp';
        tapHelp.style.display = 'none';
        controlGroup.appendChild(tapHelp);
      }
    }

    // Load main.js (migrated version is now the main)
    import('./main.js');
  </script>

  <!-- Rendimiento Audio (menú flotante) -->
  <script type="module" src="../../libs/shared-ui/performance-audio-menu.js"></script>
  <!-- Long-press para abrir el mixer -->
  <script type="module" src="../../libs/app-common/mixer-longpress.js"></script>
</body>
</html>
