<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test Game System - App5</title>
  <style>
    body {
      font-family: 'Ubuntu', sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    .test-section h2 {
      color: #666;
      font-size: 1.2rem;
      margin-top: 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
      font-size: 1rem;
    }
    button:hover {
      background: #45a049;
    }
    button.secondary {
      background: #2196F3;
    }
    button.secondary:hover {
      background: #0b7dda;
    }
    .output {
      margin-top: 10px;
      padding: 10px;
      background: #333;
      color: #0f0;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      min-height: 50px;
      white-space: pre-wrap;
    }
    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 3px;
      margin-left: 10px;
    }
    .status.success {
      background: #4CAF50;
      color: white;
    }
    .status.error {
      background: #f44336;
      color: white;
    }
    .status.info {
      background: #2196F3;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéÆ Test del Sistema de Juego - App5</h1>

    <div class="test-section">
      <h2>1. Verificaci√≥n de M√≥dulos</h2>
      <button onclick="checkModules()">Verificar M√≥dulos</button>
      <div id="modules-output" class="output">Esperando...</div>
    </div>

    <div class="test-section">
      <h2>2. Test de Character</h2>
      <button onclick="testCharacter()">Test Character</button>
      <button onclick="testMoods()" class="secondary">Test Todos los Moods</button>
      <div id="character-display" style="margin: 20px 0;"></div>
      <div id="character-output" class="output">Esperando...</div>
    </div>

    <div class="test-section">
      <h2>3. Test de Niveles</h2>
      <button onclick="testLevels()">Test Configuraci√≥n de Niveles</button>
      <button onclick="testLevel3()" class="secondary">Generar Nivel 3 Din√°mico</button>
      <div id="levels-output" class="output">Esperando...</div>
    </div>

    <div class="test-section">
      <h2>4. Test de Game State</h2>
      <button onclick="testGameState()">Test Estado del Juego</button>
      <button onclick="testSaveLoad()" class="secondary">Test Save/Load</button>
      <div id="state-output" class="output">Esperando...</div>
    </div>

    <div class="test-section">
      <h2>5. Test de UI</h2>
      <button onclick="testUI()">Inicializar UI</button>
      <button onclick="showPopup()" class="secondary">Mostrar Popup</button>
      <div id="ui-output" class="output">Esperando...</div>
    </div>

    <div class="test-section">
      <h2>6. Test Integrado</h2>
      <button onclick="runIntegrationTest()">Ejecutar Test Completo</button>
      <div id="integration-output" class="output">Esperando...</div>
    </div>
  </div>

  <script type="module">
    // Import modules
    import { Character } from './game/character.js';
    import { getLevel, getAllLevelNumbers, checkLevelCompletion } from './game/levels-config.js';
    import { GameState } from './game/game-state.js';
    import { GameUI } from './game/game-ui.js';
    import { GameManager } from './game/game-manager.js';

    // Make available globally for button onclick handlers
    window.Character = Character;
    window.getLevel = getLevel;
    window.getAllLevelNumbers = getAllLevelNumbers;
    window.checkLevelCompletion = checkLevelCompletion;
    window.GameState = GameState;
    window.GameUI = GameUI;
    window.GameManager = GameManager;

    // Module check
    window.checkModules = function() {
      const output = document.getElementById('modules-output');
      try {
        const modules = [
          { name: 'Character', exists: !!window.Character },
          { name: 'getLevel', exists: !!window.getLevel },
          { name: 'GameState', exists: !!window.GameState },
          { name: 'GameUI', exists: !!window.GameUI },
          { name: 'GameManager', exists: !!window.GameManager }
        ];

        let result = '‚úÖ M√≥dulos cargados:\n\n';
        modules.forEach(m => {
          result += `${m.exists ? '‚úì' : '‚úó'} ${m.name}\n`;
        });

        output.textContent = result;
      } catch (error) {
        output.textContent = '‚ùå Error: ' + error.message;
      }
    };

    // Character tests
    window.testCharacter = function() {
      const output = document.getElementById('character-output');
      const display = document.getElementById('character-display');
      try {
        const character = new Character();
        display.innerHTML = character.getSVG('neutral');
        output.textContent = '‚úÖ Character creado exitosamente\n';
        output.textContent += `Session Hue: ${character.sessionHue.toFixed(0)}¬∞\n`;
        output.textContent += `Moods disponibles: ${Object.keys(character.moods).join(', ')}`;
      } catch (error) {
        output.textContent = '‚ùå Error: ' + error.message;
      }
    };

    window.testMoods = async function() {
      const output = document.getElementById('character-output');
      const display = document.getElementById('character-display');
      try {
        const character = new Character();
        const moods = Object.keys(character.moods);

        for (const mood of moods) {
          display.innerHTML = character.getSVG(mood);
          output.textContent = `Mostrando mood: ${mood}`;
          await new Promise(r => setTimeout(r, 1000));
        }

        output.textContent = '‚úÖ Todos los moods probados';
      } catch (error) {
        output.textContent = '‚ùå Error: ' + error.message;
      }
    };

    // Level tests
    window.testLevels = function() {
      const output = document.getElementById('levels-output');
      try {
        let result = 'üìä Configuraci√≥n de Niveles:\n\n';

        for (let i = 1; i <= 4; i++) {
          const level = getLevel(i);
          result += `Nivel ${i}:\n`;
          result += `  - Requisito: ${level.requirement}\n`;
          result += `  - BPM: ${level.bpm || 'Variable'}\n`;
          result += `  - Lg: ${level.lg || 'Variable'}\n`;
          if (level.solution) {
            result += `  - Soluci√≥n: [${level.solution.join(', ')}]\n`;
          }
          result += '\n';
        }

        output.textContent = result;
      } catch (error) {
        output.textContent = '‚ùå Error: ' + error.message;
      }
    };

    window.testLevel3 = function() {
      const output = document.getElementById('levels-output');
      try {
        let result = 'üé≤ Generando 5 configuraciones del Nivel 3:\n\n';

        for (let i = 0; i < 5; i++) {
          const level = getLevel(3);
          result += `Configuraci√≥n ${i + 1}:\n`;
          result += `  - Lg: ${level.lg}, BPM: ${level.bpm}\n`;
          result += `  - Requisito: ${level.requirement}\n\n`;
        }

        output.textContent = result;
      } catch (error) {
        output.textContent = '‚ùå Error: ' + error.message;
      }
    };

    // Game State tests
    window.testGameState = function() {
      const output = document.getElementById('state-output');
      try {
        const gameState = new GameState();
        const stats = gameState.getStatsSummary();

        let result = 'üìà Estado del Juego:\n\n';
        result += `Progreso: ${stats.progress}%\n`;
        result += `Nivel Actual: ${stats.currentLevel}\n`;
        result += `Niveles Completados: ${stats.completedLevels}\n`;
        result += `Intentos Totales: ${stats.totalAttempts}\n`;
        result += `Tasa de √âxito: ${stats.successRate.toFixed(1)}%\n`;
        result += `Racha Actual: ${stats.currentStreak}\n`;
        result += `Logros: ${stats.achievementsUnlocked}/${stats.totalAchievements}\n`;

        output.textContent = result;
      } catch (error) {
        output.textContent = '‚ùå Error: ' + error.message;
      }
    };

    window.testSaveLoad = function() {
      const output = document.getElementById('state-output');
      try {
        const gameState = new GameState();

        // Simular progreso
        gameState.markLevelComplete(1, 95, 15000);
        gameState.markLevelComplete(2, 88, 20000);

        // Guardar
        gameState.save();

        // Exportar
        const backup = gameState.export();

        // Reset
        gameState.reset(false);

        // Importar
        gameState.import(backup);

        const stats = gameState.getStatsSummary();

        let result = 'üíæ Test Save/Load:\n\n';
        result += '‚úÖ Datos guardados y restaurados\n';
        result += `Niveles completados: ${gameState.completedLevels.join(', ')}\n`;
        result += `Precisi√≥n media: ${stats.averageAccuracy.toFixed(1)}%\n`;

        output.textContent = result;
      } catch (error) {
        output.textContent = '‚ùå Error: ' + error.message;
      }
    };

    // UI tests
    let gameUI;
    window.testUI = function() {
      const output = document.getElementById('ui-output');
      try {
        gameUI = new GameUI();
        gameUI.init();
        output.textContent = '‚úÖ UI inicializada\n';
        output.textContent += 'Usa "Mostrar Popup" para ver la interfaz';
      } catch (error) {
        output.textContent = '‚ùå Error: ' + error.message;
      }
    };

    window.showPopup = function() {
      const output = document.getElementById('ui-output');
      try {
        if (!gameUI) {
          gameUI = new GameUI();
          gameUI.init();
        }
        gameUI.show(1);
        output.textContent = '‚úÖ Popup mostrado\n';
        output.textContent += 'Cierra con la X o haciendo clic fuera';
      } catch (error) {
        output.textContent = '‚ùå Error: ' + error.message;
      }
    };

    // Integration test
    window.runIntegrationTest = async function() {
      const output = document.getElementById('integration-output');
      try {
        output.textContent = 'üîÑ Iniciando test integrado...\n\n';

        // 1. Create game manager
        const gameManager = new GameManager();
        output.textContent += '‚úÖ GameManager creado\n';
        await new Promise(r => setTimeout(r, 500));

        // 2. Initialize
        gameManager.init();
        output.textContent += '‚úÖ GameManager inicializado\n';
        await new Promise(r => setTimeout(r, 500));

        // 3. Test level validation
        const positions1 = [1, 3];
        const isCorrect1 = checkLevelCompletion(1, positions1);
        output.textContent += `‚úÖ Nivel 1 validaci√≥n: ${isCorrect1 ? 'Correcto' : 'Incorrecto'}\n`;

        const positions2 = [2, 4];
        const isCorrect2 = checkLevelCompletion(2, positions2);
        output.textContent += `‚úÖ Nivel 2 validaci√≥n: ${isCorrect2 ? 'Correcto' : 'Incorrecto'}\n`;

        // 4. Test game state persistence
        gameManager.gameState.markLevelComplete(1, 100, 10000);
        output.textContent += '‚úÖ Nivel 1 marcado como completo\n';

        const stats = gameManager.gameState.getStatsSummary();
        output.textContent += `‚úÖ Progreso total: ${stats.progress}%\n`;

        output.textContent += '\nüéâ Test integrado completado exitosamente';

      } catch (error) {
        output.textContent += '\n‚ùå Error: ' + error.message;
      }
    };

    // Auto-check modules on load
    setTimeout(checkModules, 100);
  </script>
</body>
</html>